<analysis>
The AI engineer's work primarily focused on enhancing the Agente Coruja application. Key tasks included fixing a critical frontend rendering issue caused by incorrect environment variable access ( vs  in Vite) across numerous files. Subsequently, visible debug warnings were eliminated, and the old conversational AI was successfully replaced by a proactive alert system on the  page. A full user journey simulation revealed bugs: non-persisting data, missing API endpoints (, , ), and a missing  field in the  model, all of which were addressed. A crucial discovery determined that Dra. Paula's AI knowledge base was entirely local, enabling a secure, gradual migration to Gemini, which was implemented as a hybrid system. The automated visa update system was improved with APScheduler integration and API endpoints. Most recently, the system was enhanced to differentiate visa fees and processing times for Consular Process versus Change of Status, which involved creating new backend data structures and updating the  frontend component. Finally, a  component was introduced at the start of the application flow to capture the user's process choice, which was successfully integrated into the backend.
</analysis>

<product_requirements>
The Agente Coruja (Owl Agent) is an AI-powered platform designed to simplify US immigration processes with strong data privacy. It features an intelligent, multi-lingual OpenAI GPT-5 questionnaire with real-time validation and progress saving. A Stripe-integrated payment flow enables application package download, followed by data deletion. The I-539 tourist visa extension is fully implemented. An Automated Visa Update System is being developed for weekly updates requiring administrative approval. Recent enhancements include intelligent completeness analysis, social proof, adaptive language modes, and proactive alerts to guide users and prevent incomplete applications. The system now needs to clearly distinguish between Consular Process and Change of Status throughout the user's application journey.
</product_requirements>

<key_technical_concepts>
- **Full-Stack:** React frontend (Vite), Python FastAPI backend.
- **Database:** MongoDB.
- **AI Integration:**  (LlmChat) for OpenAI GPT-5 and Gemini.
- **Asynchronous Programming:**  in FastAPI.
- **Scheduling:** APScheduler for automated tasks.
- **Adaptive UI:** Context-driven language and guidance.
</key_technical_concepts>

<code_architecture>
The application has a monorepo structure with  (FastAPI) and  (React/Vite).



-   ****
    -   **Importance:** Main FastAPI app, API routes, DB connections.
    -   **Summary of Changes:** Fixed  and  initialization. Added new API endpoints: , ,  for full application flow. Integrated APScheduler for visa updates, including startup/shutdown events and new admin endpoints. Added  and  to  model. Included a new endpoint  to serve detailed visa process information.  was added.
-   ****
    -   **Importance:** Logic for web scraping and AI detection of visa rule changes.
    -   **Summary of Changes:** Fixed  usage to  instead of  or .
-   ****
    -   **Importance:** Analyzes user input completeness using AI.
    -   **Summary of Changes:** Corrected  usage. Contains  which was identified for future updates with detailed visa info.
-   **** (NEWLY DISCOVERED)
    -   **Importance:** Contains Dra. Paula's knowledge base, determined to be local.
    -   **Summary of Changes:** Identified for use in the new hybrid agent.
-   **** (NEW FILE)
    -   **Importance:** New agent specifically for Gemini.
    -   **Summary of Changes:** Created as part of the Gemini migration strategy.
-   **** (NEW FILE)
    -   **Importance:** Script to attempt extraction of knowledge from OpenAI Assistant.
    -   **Summary of Changes:** Created and executed, revealing the OpenAI Assistant ID was non-existent.
-   **** (NEW FILE)
    -   **Importance:** Manages AI responses, attempting Gemini first with a fallback to OpenAI.
    -   **Summary of Changes:** Created, with multiple fixes to  usage (session_id,  parameter,  order, , ) for correct Gemini/OpenAI interaction.
-   **** (NEW FILE)
    -   **Importance:** Handles scheduled execution of visa updates using APScheduler.
    -   **Summary of Changes:** Created to manage and trigger .
-   **** (NEW FILE)
    -   **Importance:** Stores detailed visa information, differentiating between consular process and change of status.
    -   **Summary of Changes:** Created to centralize and structure this new data.
-   ****
    -   **Importance:** Root component for routing and global providers.
    -   **Summary of Changes:** Multiple  references were replaced with .
-   ****
    -   **Importance:** User's basic data entry page.
    -   **Summary of Changes:** Removed a visible debug information block.  (old conversational AI) was replaced with  and  was added.
-   ****
    -   **Importance:** Page where users select the visa type.
    -   **Summary of Changes:** Modified to integrate  before visa selection, storing the user's  choice and passing it to the  function.
-   ****
    -   **Importance:** React context for managing adaptive language settings.
    -   **Summary of Changes:**  was replaced with .
-   ****
    -   **Importance:** Displays visa requirements and related information.
    -   **Summary of Changes:** The file was re-created to fetch and display detailed visa information (consular vs. change of status) using Tabs, leveraging the new  endpoint.
-   **** (NEW FILE)
    -   **Importance:** Allows users to choose between Consular Process and Change of Status at the start of the application.
    -   **Summary of Changes:** Created and integrated into .
</code_architecture>

<pending_tasks>
- **Full I-539 Functionality:**
    - Ensure  form_code is correctly saved and persisted in the backend.
    - Verify I-539 specific field guidance is consistently provided, not generic.
    - Ensure the I-539 card is correctly displayed and visible in the frontend.
- ** Bug:** An old bug where selecting a visa type defaults to B-1/B-2 remains unaddressed.
- **Frontend Integration:** Integrate newly built backend features (Completeness Analyzer, Social Proof, Adaptive Language) into the main application flow, particularly into forms like  and .
- **Score Preditivo de Aprovação (Simple Version)**
- **Simulador de Entrevista Básico**
- **Freemium + Pricing Claro**
- **Code Cleanup (Optional):** Address remaining hardcoded fallback URLs.
- **Persistent Process Type Signal:** Implement a visual carimbo (stamp) on all pages to indicate the chosen Processo Consular or Mudança de Status.
</pending_tasks>

<current_work>
The most recent work involved implementing a crucial feature to differentiate between Consular Process and Change of Status for visa applications.

On the **backend**, a new file  was created to house structured data for both process types (e.g., separate fees, processing times, and requirements). A new API endpoint, , was added to  to serve this detailed information. The  model in  was updated to include a  field to store the user's choice.

On the **frontend**, a new component, , was created. This component provides the UI for users to select their desired process type (Consular or Change of Status). The  page was modified to render  *before* the visa type selection. The  function in  was updated to send the  selected by the user to the backend when a new case is initiated.

Additionally, the  component was entirely re-created to consume data from the new  endpoint. It now displays visa information with a tabbed interface, allowing users to view details specific to Processo Consular and Mudança de Status separately.

A full system test, including both backend and frontend, confirmed that the  is functioning correctly, and the  is being captured and stored. The detailed visa information is now accessible via the new endpoint and displayed in the  component.
</current_work>

<optional_next_step>
Implement a persistent visual indicator (carimbo) on all subsequent frontend pages to signal the user's chosen Processo Consular or Mudança de Status.
</optional_next_step>
